<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="description">
        <meta name="keywords" content="static content generator,static site generator,static site,HTML,web development,.NET,C#,Razor,Markdown,YAML">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/animancer/assets/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/animancer/assets/img/favicon.ico" type="image/x-icon">
        <title>Animancer - Attack</title>
        <link href="/animancer/assets/css/highlight.css" rel="stylesheet">
        <link href="/animancer/assets/css/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="/animancer/assets/css/adminlte/AdminLTE.css" rel="stylesheet">
        <link href="/animancer/assets/css/theme/theme.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:400,400i,700,700i" rel="stylesheet">
        <link href="/animancer/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/animancer/assets/css/override.css" rel="stylesheet">
        <script src="/animancer/assets/js/jquery-2.2.3.min.js"></script>
        <script src="/animancer/assets/js/bootstrap.min.js"></script>        
        <script src="/animancer/assets/js/app.min.js"></script>         
        <script src="/animancer/assets/js/highlight.pack.js"></script>   
        <script src="/animancer/assets/js/jquery.slimscroll.min.js"></script>
        <script src="/animancer/assets/js/jquery.sticky-kit.min.js"></script>
        <script src="/animancer/assets/js/mermaid.min.js"></script>
        <script src="/animancer/assets/js/svg-pan-zoom.min.js"></script>
        <!--[if lt IE 9]>
        <script src="/animancer/assets/js/html5shiv.min.js"></script>
        <script src="/animancer/assets/js/respond.min.js"></script>
        <![endif]-->  

        
    </head>
    <body class="hold-transition wyam layout-boxed  ">    
        <div class="top-banner"></div>
        <div class="wrapper with-container">
            <!-- Header -->
            <header class="main-header">   
                     
                <a href="/animancer/" class="logo">
                            <span>Animancer</span>
                </a>   
                         
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                        <a href="#" class="sidebar-toggle visible-xs-block" data-toggle="offcanvas" role="button">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-right"></i>
                        </a>
                                        
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-down"></i>
                        </button>
                    </div>
            
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                        <ul class="nav navbar-nav">                            
                                    <li><a href="/animancer/docs/introduction/features"><img src="/animancer/images/features.png" height="20" style="position:relative; left:-7px; top:-1px;"> Features</a></li>
        <li><a href="/animancer/docs/download"><img src="/animancer/images/download.png" height="20" style="position:relative; left:-7px; top:-1px;"> Download</a></li>
        <li class="active"><a href="/animancer/docs"><img src="/animancer/images/docs.png" height="20" style="position:relative; left:-5px; top:-1px;"> Documentation</a></li>
        <li><a href="/animancer/docs/help"><img src="/animancer/images/help.png" height="20" style="position:relative; left:-4px; top:-1px;"> Help</a></li>
        <li><a href="/animancer/api/Animancer/AnimancerComponent"><img src="/animancer/images/api.png" height="20" style="position:relative; left:-3px; top:-1px;"> API v5.2</a></li>
        <li><a href="https://kybernetik.com.au/kailas-dierk/unity-assets"><img src="/animancer/images/kybernetik.png" height="20" style="position:relative; left:-2px; top:-1px;"> Other Assets</a></li>
 
                        </ul>       
                    </div>
                    <!-- /.navbar-collapse -->
                
                    <!-- Navbar Right Menu -->
                </nav>
            </header>
            
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar ">
                <section class="infobar" data-spy="affix" data-offset-top="60" data-offset-bottom="200"> 
                    	
    <div id="infobar-headings"><h6>On This Page</h6><p><a href="#mecanim">Mecanim</a></p>
<p><a href="#animancer">Animancer</a></p>
<p><a href="#buffered-input">Buffered Input</a></p>
<p><a href="#fields">Fields</a></p>
<p><a href="#animations">Animations</a></p>
<p><a href="#state-entry">State Entry</a></p>
<p><a href="#updates">Updates</a></p>
<hr class="infobar-hidden">
</div>

                </section>
                <section class="sidebar">    
                                     
                    

                    <ul class="sidebar-menu">
                        

                <li><a href="/animancer/docs/download">Download</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/introduction">Introduction</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/introduction/features">Features</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/introduction/mecanim-vs-animancer">Mecanim vs. Animancer</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/why">Why Replace Mecanim?</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/playing">Playing</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/waiting">Waiting</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/speed-and-time">Speed and Time</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/weapon-animations">Weapon Animations</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/performance">Performance</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/introduction/glossary">Glossary</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/introduction/cs">C# in Unity</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/introduction/cs/overview">Scripting Overview</a></li>
                <li><a href="/animancer/docs/introduction/cs/organisation">Organisation</a></li>
                <li><a href="/animancer/docs/introduction/cs/variables">Variables</a></li>
                <li><a href="/animancer/docs/introduction/cs/methods">Methods</a></li>
                <li><a href="/animancer/docs/introduction/cs/inheritance">Inheritance</a></li>
                <li><a href="/animancer/docs/introduction/cs/vectors">Vectors</a></li>
                <li><a href="/animancer/docs/introduction/cs/other">Other Topics</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/docs/examples">Examples</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/docs/examples/basics">01 Basics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/basics/scene-setup">Basic Scene Setup</a></li>
                <li><a href="/animancer/docs/examples/basics/quick-play">01 Quick Play</a></li>
                <li><a href="/animancer/docs/examples/basics/playing-and-fading">02 Playing and Fading</a></li>
                <li><a href="/animancer/docs/examples/basics/sequence-coroutine">03 Sequence Coroutine</a></li>
                <li><a href="/animancer/docs/examples/basics/named-animations">04 Named Animations</a></li>
                <li><a href="/animancer/docs/examples/basics/hybrid">05 Hybrid Basics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/fine-control">02 Fine Control</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/fine-control/spider-bot">01 Spider Bot</a></li>
                <li><a href="/animancer/docs/examples/fine-control/doors">02 Doors</a></li>
                <li><a href="/animancer/docs/examples/fine-control/solo-animation">03 Solo Animation</a></li>
                <li><a href="/animancer/docs/examples/fine-control/update-rate">04 Update Rate</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/locomotion">03 Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/locomotion/walk-and-run">01 Walk and Run</a></li>
                <li><a href="/animancer/docs/examples/locomotion/root-motion">02 Root Motion</a></li>
                <li><a href="/animancer/docs/examples/locomotion/linear-blending">03 Linear Blending</a></li>
                <li><a href="/animancer/docs/examples/locomotion/directional-blending">04 Directional Blending</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/directional-sprites">04 Directional Sprites</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/directional-sprites/basic-movement">01 Basic Movement</a></li>
                <li><a href="/animancer/docs/examples/directional-sprites/character-controller">02 Character Controller</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/events">05 Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/events/footsteps">01 Footstep Events</a></li>
                <li><a href="/animancer/docs/examples/events/golf">02 Golf Events</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/fsm">06 State Machines</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/fsm/creatures">01 Creatures</a></li>
                <li><a href="/animancer/docs/examples/fsm/interrupts">02 Interrupt Management</a></li>
                <li><a href="/animancer/docs/examples/fsm/brains">03 Brains</a></li>
                <li><a href="/animancer/docs/examples/fsm/more-brains">04 More Brains</a></li>
                <li><a href="/animancer/docs/examples/fsm/weapons">05 Weapons</a></li>
                <li><a href="/animancer/docs/examples/fsm/platformer">06 Platformer</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/examples/layers">07 Layers</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/ik">08 Inverse Kinematics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/ik/puppet">01 Puppet</a></li>
                <li><a href="/animancer/docs/examples/ik/uneven-ground">02 Uneven Ground</a></li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/docs/examples/animator-controllers">09 Animator Controllers</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animator-controllers/hybrid">01 Hybrid Mini Game</a></li>
                <li class="treeview active">
                    <a href="/animancer/docs/examples/animator-controllers/3d-game-kit">02 3D Game Kit</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/problems">Problems with the Mecanim Character</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/respawn">Respawn</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/idle">Idle</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/animator-controllers/3d-game-kit/locomotion">Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/locomotion/movement">Movement</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/locomotion/turning">Turning</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/airborne">Airborne</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/landing">Landing</a></li>
                <li class="selected"><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/attack">Attack</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/flinch">Flinch</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/die">Die</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/jobs">10 Animation Jobs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/jobs/two-bone-ik">01 Two Bone IK</a></li>
                <li><a href="/animancer/docs/examples/jobs/damping">02 Damping</a></li>
                <li><a href="/animancer/docs/examples/jobs/lean">03 Lean</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/manual">User Manual</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/docs/manual/getting">Getting Animations</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/getting/mixamo">Mixamo</a></li>
                <li><a href="/animancer/docs/manual/getting/importing">Importing</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/manual/playing">Playing Animations</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/playing/states">States</a></li>
                <li><a href="/animancer/docs/manual/playing/inspector">Inspector</a></li>
                <li><a href="/animancer/docs/manual/playing/component-types">Component Types</a></li>
                <li><a href="/animancer/docs/manual/playing/directional-sets">Directional Animation Sets</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/manual/transitions">Transitions</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/transitions/types">Transition Types</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/manual/blending">Blending</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/blending/fading">Fading</a></li>
                <li><a href="/animancer/docs/manual/blending/layers">Layers</a></li>
                <li><a href="/animancer/docs/manual/blending/mixers">Mixers</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/manual/events">Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/events/animation">Animation Events</a></li>
                <li><a href="/animancer/docs/manual/events/animancer">Animancer Events</a></li>
                <li><a href="/animancer/docs/manual/events/end">End Events</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/manual/fsm">Finite State Machines</a></li>
                <li><a href="/animancer/docs/manual/animator-controllers">Animator Controllers</a></li>
                <li><a href="/animancer/docs/manual/timeline">Timeline</a></li>
                <li><a href="/animancer/docs/manual/ik">Inverse Kinematics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/bugs">Unity Bugs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/bugs/events">Animation Events</a></li>
                <li><a href="/animancer/docs/bugs/paused-skinned-mesh-update">Paused Skinned Mesh Update</a></li>
                <li><a href="/animancer/docs/bugs/serialized-array-initialization">Serialized Array Initialization</a></li>
                <li><a href="/animancer/docs/bugs/stabilize-feet">Stabilize Feet</a></li>
                <li><a href="/animancer/docs/bugs/timing">Timing</a></li>
                <li><a href="/animancer/docs/bugs/update-modes">Update Modes</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/source">Source Code</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/source/dlls">DLLs</a></li>
                <li><a href="/animancer/docs/source/creating-custom-states">Creating Custom States</a></li>
                <li><a href="/animancer/docs/source/graph-structure">Graph Structure</a></li>
                <li><a href="/animancer/docs/source/asset-sources">Asset Sources</a></li>
                <li><a href="/animancer/docs/source/coding-standard">Coding Standard</a></li>
                <li><a href="/animancer/docs/source/default-script-template">Default Script Template</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/changes">Change Log</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/changes/animancer-v5-2">Animancer v5.2</a></li>
                <li><a href="/animancer/docs/changes/animancer-v5-1">Animancer v5.1</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/changes/animancer-v5-0">Animancer v5.0</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/changes/animancer-v5-0/test">Test Releases</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/changes/animancer-v4-4">Animancer v4.4</a></li>
                <li><a href="/animancer/docs/changes/animancer-v4-3">Animancer v4.3</a></li>
                <li><a href="/animancer/docs/changes/animancer-v4-2">Animancer v4.2</a></li>
                <li><a href="/animancer/docs/changes/animancer-v4-1">Animancer v4.1</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/changes/animancer-v4-0">Animancer v4.0</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/changes/animancer-v4-0/test">Test Releases</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/changes/animancer-v3-1">Animancer v3.1</a></li>
                <li><a href="/animancer/docs/changes/animancer-v3-0">Animancer v3.0</a></li>
                <li><a href="/animancer/docs/changes/animancer-v2-0">Animancer v2.0</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-3">Animancer v1.3</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-2">Animancer v1.2</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-1">Animancer v1.1</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-0">Animancer v1.0</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/help">Help and FAQ</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/help/debugging">Debugging</a></li>

                    </ul>
                </li>

                    </ul>
                            
                </section>                
            </aside>
            
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                



		<section class="content-header">
			<h1>Attack</h1>
		</section>
	<section class="content">
		<blockquote class="blockquote">
<p>This page is part of the <a href="../">3D Game Kit</a> example.</p>
</blockquote>
<p>Most combat games feature attack combos where performing multiple attacks in quick succession will use various different animations in a sequence which resets to the beginning if you stop attacking or reach the end, which is what we have here:</p>
<p><img src="combo.gif" class="img-responsive"></p>
<h1 id="mecanim">Mecanim</h1>
<p>The Mecanim character's <code>MeleeCombatSM</code> state is a <a href="https://docs.unity3d.com/Manual/NestedStateMachines.html">Sub State Machine</a> containing several <em>Attack</em> animations:</p>
<p><img src="attack-sub-state.png" class="img-responsive"></p>
<p><img src="attack-transition.png" class="img-responsive img-right"> At first glance, the general concept is easy to understand - it will start with the first <em>Attack</em> animation (<code>EllenCombo1</code>) and continue to each of the others in order if you keep trying to attack - but as usual, the specific implementation of that logic is scattered all over the place:</p>
<ol>
<li><code>PlayerInput.Update</code> checks for the attack input in order to start the <code>AttackWait</code> coroutine.</li>
<li><code>AttackWait</code> sets <code>m_Attack = true;</code> then waits for 0.03 seconds, then sets it back to <code>false</code>. This is a dirty hack to ensure that the input doesn't get missed in case there are multiple <code>Update</code>s in a row without a <code>FixedUpdate</code> between them, but otherwise it's an arbitrary amount of time which is too small to have any other use.</li>
<li><code>PlayerController.FixedUpdate</code> resets the <code>MeleeAttack</code> trigger in the Animator Controller every frame and then sets it if the above input was detected. This means it should just be a bool parameter since the features of a trigger aren't even being used.</li>
<li><code>FixedUpdate</code> also gets the normalized time of the current state from the Animator Controller and sends it back into the <code>StateTime</code> parameter.</li>
<li>The Animator Controller uses the <code>MeleeAttack</code> trigger to transition into the <code>MeleeCombatSM</code> sub state machine and play the first attack animation (<code>EllenCombo1</code>).</li>
<li><code>FixedUpdate</code> also calls <code>SetTargetRotation</code> which checks <code>if (m_InAttack)</code> in order to turn the player towards a nearby enemy if there is one.</li>
<li>Searching for references to <code>m_InAttack</code> finds that the only place it gets set to true is the <code>MeleeAttackStart</code> method which has a comment explaining that it is called by an <a href="../../../../manual/events/animation">Animation Event</a>.</li>
<li><code>FixedUpdate</code> also calls <code>PlayAudio</code> which plays a sound if one of the attack states was just entered. This is another dirty hack because it does so by checking each of the individual state names (<code>EllenCombo1</code>, <code>EllenCombo2</code>, etc.).</li>
<li>Each of the <code>EllenCombo</code> states has a <code>StateMachineBehaviour</code> called <code>EllenStaffEffect</code> with an <code>int effectIndex</code> which is set in the Inspector. When a state is entered its <code>OnStateEnter</code> method gets the <code>PlayerController</code> and accesses the effect of their weapon at the specified index in order to call <code>TimeEffect.Activate</code> on it.</li>
<li>That method activates an animated weapon trail and a <code>Light</code>, then uses a coroutine to wait until the animation finishes to deactivate it.</li>
<li>Each of the <code>EllenCombo</code> states has various transitions, including one which leads to the next state in the sequence on the conditions that <code>MeleeAttack</code> is true (meaning the player is trying to attack) and the <code>StateTime</code> (from step #4) is within a certain range.</li>
</ol>
<p>Note how several of those steps so not directly lead into the next. <code>PlayerInput</code> does not just call a method which you can read to in order to find out what it does, instead it sets a value and you need to check everywhere that references that value to find out what effect it will have. This is a big part of what makes the setup so convoluted.</p>
<h1 id="animancer">Animancer</h1>
<p></p><details><summary>The Animancer character handles all the above logic in the <code>AttackState</code> script which makes the flow of logic far easier to understand:</summary><p>
</p><pre><code class="language-cs">using Animancer;
using System;
using UnityEngine;
using UnityEngine.Events;

public sealed class AttackState : CreatureState
{
    [SerializeField] private float _TurnSpeed = 400;
    [SerializeField] private UnityEvent _SetWeaponOwner;
    [SerializeField] private UnityEvent _OnStart;
    [SerializeField] private UnityEvent _OnEnd;
    [SerializeField] private ClipState.Transition[] _Animations;

    private int _AttackIndex = int.MaxValue;
    private <a href="/animancer/api/Animancer/Transition">ClipState.Transition</a> _Attack;

    private void Awake()
    {
        _SetWeaponOwner.Invoke();
    }

    public override bool CanEnterState(CreatureState previousState) =&gt; Creature.CharacterController.isGrounded;

    private void OnEnable()
    {
        if (_AttackIndex &gt;= _Animations.Length - 1 ||
            _Animations[_AttackIndex].State.Weight == 0)
        {
            _AttackIndex = 0;
        }
        else
        {
            _AttackIndex++;
        }

        _Attack = _Animations[_AttackIndex];
        Creature.Animancer.Play(_Attack);
        <a href="/animancer/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/224320DD">Creature.ForwardSpeed</a> = 0;
        _OnStart.Invoke();
    }

    private void OnDisable()
    {
        _OnEnd.Invoke();
    }

    public override bool FullMovementControl =&gt; false;

    private void FixedUpdate()
    {
        if (Creature.CheckMotionState())
            return;

        Creature.TurnTowards(Creature.Brain.Movement, _TurnSpeed);
    }

    public override bool CanExitState(CreatureState nextState)
    {
        return _Attack.State.NormalizedTime &gt;= _Attack.State.Events.NormalizedEndTime;
    }
}
</code></pre>
<p></p></details><p></p>
<p>Well, not quite <em>all</em> the logic:</p>
<h1 id="buffered-input">Buffered Input</h1>
<p>The initial input check is handled by the <code><a href="/animancer/api/Animancer.Examples.AnimatorControllers.GameKit/KeyboardAndMouseBrain">KeyboardAndMouseBrain</a></code> script.</p>
<p>It starts with a reference to the <em>Attack</em> state which is assigned in the Inspector.</p>
<pre><code class="language-cs">[SerializeField] private CreatureState _Attack;
</code></pre>
<p>Note that this is the only place where the <em>Attack</em> state is actually referenced. The <code>Creature</code> script has references to the core states - <em>Respawn</em>, <em>Idle</em>, <em>Locomotion</em>, and <em>Airborne</em> - but none of them know anything about the ability to attack.</p>
<p>In the Mecanim character, each attack has a window of time during which you could press the attack button to perform the next attack in the combo (step #11 above). These windows were defined in the transition conditions which made them tricky to work with for two main reasons:</p>
<ul>
<li>You cannot view more than one at a time and it takes two clicks to swap between them.</li>
<li>Since the <code>StateTime</code> parameter is actually set using the state's normalized time, it is hard to judge how much time a particular value actually represents.</li>
</ul>
<p>Instead of trying to replicate that setup, the Animancer character instead uses Animancer's <a href="../../../../manual/fsm#input-buffers">Input Buffering</a> system in exactly the same way it was used in the <a href="../../../fsm/weapons#attack-input">Weapons</a> example.</p>
<h1 id="fields">Fields</h1>
<p>Now that we have taken care of getting the character into the <code>AttackState</code>, we can make some <a href="../../../../introduction/cs/variables#serialized-fields">Serialized Fields</a> to show in the Inspector:</p>
<table class="table">
  <thead>
    <tr><th style="width:50%">Code</th>
    <th style="width:50%">Inspector</th>
  </tr></thead>
  <tbody>
    <tr>
      <td>
<pre><code class="language-cs">[SerializeField]
private float _TurnSpeed = 400;

[SerializeField]
private UnityEvent _SetWeaponOwner;

[SerializeField]
private UnityEvent _OnStart;

[SerializeField]
private UnityEvent _OnEnd;

[SerializeField]
private ClipState.Transition[] _Animations;
</code></pre>
<p>In order to interact with the existing systems in the 3D Game Kit Lite (such as killing enemies and breaking destructible boxes) we need to call several methods on its scripts, but the <a href="../problems#script-referencing">Script Referencing</a> issue prevents us from calling them directly so we use <code>UnityEvents</code> instead:</p>
<ul>
<li><code>_SetWeaponOwner</code> is used in <code>Awake</code> to call <code>MeleeWeapon.SetOwner</code> so that when the weapon hits an enemy it can pass the relevant information about the character wielding it to the enemy being hit.</li>
<li><code>_OnStart</code> activates the weapon (most games have the weapon always visible, but the Mecanim character only shows it when attacking so we just do the same here) and calls <code>MeleeWeapon.BeginAttack</code> so that it will start checking for objects to hit.</li>
<li><code>_OnEnd</code> cancels out what <code>_OnStart</code> did.</li>
</ul>
</td>
      <td><img src="inspector.png" class="img-responsive"></td>
    </tr>
  </tbody>
</table>
<p>We also need some non-serialized fields to remember the index of the current attack (to play the next one in the sequence when the player attacks repeatedly) and keep a direct reference to that attack for use later on:</p>
<pre><code class="language-cs">private int _AttackIndex = int.MaxValue;
private <a href="/animancer/api/Animancer/Transition">ClipState.Transition</a> _Attack;
</code></pre>
<h1 id="animations">Animations</h1>
<img src="inspector-animations.png" class="img-responsive img-right">
<p>Expanding the foldout arrow next to each of the <a href="../../../../manual/transitions">Transitions</a> allows us to customise the <code>Fade Duration</code> and <code>End Time</code> of each attack.</p>
<h2 id="weapon-trails">Weapon Trails</h2>
<p>Whenever we play one of the attack animations, we also want to show a trail of blue light behind the weapon swing. This is handled by the <code>TimeEffect</code> script from the 3D Game Kit Lite which the <a href="../problems#script-referencing">Script Referencing</a> issue prevents us from using directly. But rather than adding a <code>UnityEvent</code> field as we have in other cases, we can make use of the fact that <a href="../../../../manual/transitions">Transitions</a> already have built in <a href="../../../../manual/events/animancer">Animancer Events</a> by simply creating an event at time 0 and using its <a href="../../../../introduction/cs/methods#unity-events">Unity Event</a> to call the <code>TimeEffect.Activate</code>.</p>
<p>In this case the trails are separately animated meshes so if we wanted the ability to tweak the <code>Speed</code> of the attack animation, we would also need to pass that speed onto the trail so it gets shown correctly in relation to the character.</p>
<p>Rather than using a separately animated mesh for the trails, most games generally use Unity's <a href="https://docs.unity3d.com/Manual/class-TrailRenderer">Trail Renderer</a> component (or a custom script that works similarly) to have the trail dynamically follow wherever the weapon goes. This would avoid the speed issue and require less effort to develop, but it does somewhat limit your creative control over the exact appearance of the effect.</p>
<h2 id="attack-details">Attack Details</h2>
<p>The 3D Game Kit Lite uses a very basic damage system where the player kills enemies and destroys objects in one hit and enemies cause the player to lose 1 health on contact. But many games allow different weapons to deal different amounts of damage, knock enemies away, and even cause them to <a href="../flinch">Flinch</a> for different amounts of time. Some games even allow individual attacks with the same weapon to use different stats such as having a sword deal <em>Slashing</em> damage with one attack then <em>Piercing</em> damage with the next or having a weak bash attack followed by a powerful overhead strike.</p>
<p>Associating additional details like that with each animation can be done by creating a class that <a href="../../../../introduction/cs/inheritance">Inherits</a> from <code><a href="/animancer/api/Animancer/Transition">ClipState.Transition</a></code>, just like how the <a href="../../../locomotion/root-motion">Root Motion</a> example allows each transition to determine whether it wants to use root motion or not.</p>
<h2 id="adding-more-attacks">Adding More Attacks</h2>
<p>Much like if we want to <a href="../idle#adding-more-idles">add more idle animations</a>, building this script to use an array makes it much easier to modify the general behaviour and set up any number of animations without needing to set up the same states, transitions, and <code>StateMachineBehaviour</code>s every time as you would when using Mecanim.</p>
<h1 id="state-entry">State Entry</h1>
<p>In this example, we only allow attacking while grounded:</p>
<pre><code class="language-cs">public override bool CanEnterState(CreatureState previousState) =&gt; Creature.CharacterController.isGrounded;
</code></pre>
<p>Games often have different attacks they can use while <a href="../airborne">Airborne</a> as well, which could be achieved by giving this state an Inspector <code>bool</code> to determine whether it is for ground or air attacks and attaching two of them to the same <code>Creature</code>, or by giving it a second array of <code><a href="/animancer/api/Animancer/Transition">ClipState.Transition</a></code>s to use when airborne.</p>
<p>When entering this state, we start by determining which attack in the sequence we are up to. If the previous attack was the last one or it has already fully faded out, we want the first attack, but otherwise we can go to the next one in line:</p>
<pre><code class="language-cs">private void OnEnable()
{
    if (_AttackIndex &gt;= _Animations.Length - 1 ||
        _Animations[_AttackIndex].State.Weight == 0)
    {
        _AttackIndex = 0;
    }
    else
    {
        _AttackIndex++;
    }
</code></pre>
<p>Note how we initialised the index to start at <code>int.MaxValue</code> when declaring the field so that the first condition checked by <code>OnEnable</code> is true the first time it is used.</p>
<p>Now that we know which attack is starting, we can play it:</p>
<pre><code class="language-cs">    _Attack = _Animations[_AttackIndex];
    Animancer.Play(_Attack);
    <a href="/animancer/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/224320DD">Creature.ForwardSpeed</a> = 0;
    _OnStart.Invoke();
}
</code></pre>
<h1 id="updates">Updates</h1>
<p>While this state is active, we want to apply the raw root motion from the attack animations so we disable <code>FullMovementControl</code>:</p>
<pre><code class="language-cs">public override bool FullMovementControl =&gt; false;
</code></pre>
<p>This <code>FixedUpdate</code> method is the simplest of any state, we just <a href="../idle#check-motion-state">check the standard transitions</a> (<em>Idle</em>, <em>Locomotion</em>, or <em>Airborne</em> as appropriate) and turn in the direction the <code>Creature.Brain</code> wants to go:</p>
<pre><code class="language-cs">private void FixedUpdate()
{
    if (Creature.CheckMotionState())
        return;

    Creature.TurnTowards(Creature.Brain.Movement, _TurnSpeed);
}
</code></pre>
<p>On its own, <code>CheckMotionState</code> would immediately go to a different state, however we want to prevent other actions from interrupting attacks until they are done so we override <code>CanExitState</code> to base its answer on the time of the current attack:</p>
<pre><code class="language-cs">public override bool CanExitState(CreatureState nextState)
{
    return _Attack.State.NormalizedTime &gt;= _Attack.EndNormalizedTime;
}
</code></pre>
<p>This means that once the specified time passes, the next <code>FixedUpdate</code> will change to one of the standard states (and that state will be responsible for fading in its own animation). If the <a href="#input-buffer">Input Buffer</a> is attempting to attack again, it will then do so next time it is updated, which will enter this state again. Since the attack animation that just ended would still be fading out at that point, the <code>OnEnable</code> method would then move it onto the next attack in the sequence.</p>
<p>We are using the <a href="../../../../manual/events/end">End Event</a> time to determine when this state is alowed to exit which makes it seem like we could just use an actual event instead of calling <code>Creature.CheckMotionState</code> every frame, but that would not work because:</p>
<ul>
<li>If <code>CanExitState</code> always returns false, <code>Creature.CheckMotionState</code> will not work because it uses <code>TrySetState</code> instead of <code>ForceSetState</code>.</li>
<li>If <code>CanExitState</code> always returns true, it would allow other actions like jumping in the middle of an attack.</li>
</ul>

	</section>
                
            </div>           
            
            <!-- Footer -->
            <footer class="main-footer">
            </footer>
            
        </div>
        <div class="wrapper bottom-wrapper">
            <footer class="bottom-footer">
                Generated by <a href="https://wyam.io">Wyam</a>
            </footer>
        </div>
        <a href="javascript:" id="return-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <script>           
            // Close the sidebar if we select an anchor link
            $(".main-sidebar a[href^='#']:not('.expand')").click(function(){
                $(document.body).removeClass('sidebar-open');
            });
            
            $(document).ready(function() {
                mermaid.initialize(
                {
                    flowchart:
                    {
                        useMaxWidth: false
                    },
					startOnLoad: false,
					cloneCssStyles: false
                });     
                mermaid.init(undefined, ".mermaid");

                // Remove the max-width setting that Mermaid sets
                var mermaidSvg = $('.mermaid svg');
                mermaidSvg.addClass('img-responsive');
                mermaidSvg.css('max-width', '');

                // Make it scrollable
				var target = document.querySelector(".mermaid svg");
				if(target !== null)
				{
					var panZoom = window.panZoom = svgPanZoom(target, {
						zoomEnabled: true,
						controlIconsEnabled: true,
						fit: true,
						center: true,
                        maxZoom: 20,
                        zoomScaleSensitivity: 0.6
					});			                          

                    // Do the reset once right away to fit the diagram
                    panZoom.resize();
                    panZoom.fit();
                    panZoom.center();
                    
                    $(window).resize(function(){
                        panZoom.resize();
                        panZoom.fit();
                        panZoom.center();
                    });
				}
                
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });  
            });

            hljs.initHighlightingOnLoad();

            // Back to top
            $(window).scroll(function() {
                if ($(this).scrollTop() >= 200) {        // If page is scrolled more than 50px
                    $('#return-to-top').fadeIn(1000);    // Fade in the arrow
                } else {
                    $('#return-to-top').fadeOut(1000);   // Else fade out the arrow
                }
            });
            $('#return-to-top').click(function() {      // When arrow is clicked
                $('body,html').animate({
                    scrollTop : 0                       // Scroll to top of body
                }, 500);
            });
        </script>
    
</body></html>