<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="description">
        <meta name="keywords" content="static content generator,static site generator,static site,HTML,web development,.NET,C#,Razor,Markdown,YAML">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <title>Animancer - 02 Root Motion</title>
        <link href="/animancer/v4-0/assets/css/highlight.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/adminlte/AdminLTE.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/theme/theme.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:400,400i,700,700i" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/animancer/v4-0/assets/css/override.css" rel="stylesheet">
        <script src="/animancer/v4-0/assets/js/jquery-2.2.3.min.js"></script>
        <script src="/animancer/v4-0/assets/js/bootstrap.min.js"></script>        
        <script src="/animancer/v4-0/assets/js/app.min.js"></script>         
        <script src="/animancer/v4-0/assets/js/highlight.pack.js"></script>   
        <script src="/animancer/v4-0/assets/js/jquery.slimscroll.min.js"></script>
        <script src="/animancer/v4-0/assets/js/jquery.sticky-kit.min.js"></script>
        <script src="/animancer/v4-0/assets/js/mermaid.min.js"></script>
        <script src="/animancer/v4-0/assets/js/svg-pan-zoom.min.js"></script>
        <!--[if lt IE 9]>
        <script src="/animancer/v4-0/assets/js/html5shiv.min.js"></script>
        <script src="/animancer/v4-0/assets/js/respond.min.js"></script>
        <![endif]-->  

        
    </head>
    <body class="hold-transition wyam layout-boxed  ">    
        <div class="top-banner"></div>
        <div class="wrapper with-container">
            <!-- Header -->
            <header class="main-header">   
                     
                <a href="/animancer/v4-0/" class="logo">
                            <span>Animancer</span>
                </a>   
                         
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                        <a href="#" class="sidebar-toggle visible-xs-block" data-toggle="offcanvas" role="button">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-right"></i>
                        </a>
                                        
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-down"></i>
                        </button>
                    </div>
            
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                        <ul class="nav navbar-nav">                            
                                    <li class="active"><a href="/animancer/v4-0/docs"><img src="/animancer/v4-0/images/docs.png" height="20" style="position:relative; left:-5px; top:-1px;"> Docs</a></li>
        <li><a href="/animancer/v4-0/docs/help"><img src="/animancer/v4-0/images/help.png" height="20" style="position:relative; left:-4px; top:-1px;"> Help</a></li>
        <li><a href="/animancer/v4-0/api/Animancer/AnimancerComponent"><img src="/animancer/v4-0/images/api.png" height="20" style="position:relative; left:-3px; top:-1px;"> API v4.0</a></li>
        <li><a href="/animancer/lite"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Try</a></li>
        <li><a href="/animancer/pro"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Buy</a></li>
        <li><a href="https://kybernetik.com.au/kailas-dierk/unity-assets"><img src="/animancer/v4-0/images/kybernetik.png" height="20" style="position:relative; left:-2px; top:-1px;"> Other Assets</a></li>
 
                        </ul>       
                    </div>
                    <!-- /.navbar-collapse -->
                
                    <!-- Navbar Right Menu -->
                </nav>
<a href="/animancer" style="font-size:1.42em; color:white">This is the <strong>Animancer v4.0 Beta</strong> Documentation. Click Here to return to the v3.1 Documentation.</a>
            </header>
            
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar ">
                <section class="infobar" data-spy="affix" data-offset-top="60" data-offset-bottom="200"> 
                    	
    <div id="infobar-headings"><h6>On This Page</h6><p><a href="#teleporting">Teleporting</a></p>
<p><a href="#animation-metadata">Animation Metadata</a></p>
<p><a href="#transitions">Transitions</a></p>
<p><a href="#redirecting-root-motion">Redirecting Root Motion</a></p>
<hr class="infobar-hidden">
</div>

                </section>
                <section class="sidebar">    
                                     
                    

                    <ul class="sidebar-menu">
                        

                <li><a href="/animancer/v4-0/docs/help">Help and FAQ</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction">Introduction</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/features">Features</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer">Mecanim vs. Animancer</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/why-replace-mecanim">Why Replace Mecanim?</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/playing">Playing</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/waiting">Waiting</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/speed-and-time">Speed and Time</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/weapon-animations">Weapon Animations</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/performance">Performance</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/introduction/glossary">Glossary</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/cs">C# in Unity</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/cs/overview">Scripting Overview</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/organisation">Organisation</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/variables">Variables</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/methods">Methods</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/inheritance">Inheritance</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/vectors">Vectors</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/other">Other Topics</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples">Examples</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/basics">01 Basics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/basics/scene-setup">Basic Scene Setup</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/quick-play">01 Quick Play</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/playing-and-fading">02 Playing and Fading</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/sequence-coroutine">03 Sequence Coroutine</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/named-animations">04 Named Animations</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/hybrid">05 Hybrid Basics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/fine-control">02 Fine Control</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/fine-control/spider-bot">01 Spider Bot</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/doors">02 Doors</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/solo-animation">03 Solo Animation</a></li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples/locomotion">03 Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/locomotion/walk-and-run">01 Walk and Run</a></li>
                <li class="selected"><a href="/animancer/v4-0/docs/examples/locomotion/root-motion">02 Root Motion</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/linear-blending">03 Linear Blending</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/directional-blending">04 Directional Blending</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/directional-sprites">04 Directional Sprites</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/basic-movement">01 Basic Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/character-controller">02 Character Controller</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/events">05 Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/events/footsteps">01 Footstep Events</a></li>
                <li><a href="/animancer/v4-0/docs/examples/events/golf">02 Golf Events</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/fsm">06 State Machines</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/fsm/creatures">01 Creatures</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/interrupt-management">02 Interrupt Management</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/brains">03 Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/more-brains">04 More Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/platformer">05 Platformer</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/layers">07 Layers</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/ik">08 Inverse Kinematics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/ik/puppet">01 Puppet</a></li>
                <li><a href="/animancer/v4-0/docs/examples/ik/uneven-ground">02 Uneven Ground</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers">09 Animator Controllers</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/hybrid">01 Hybrid Mini Game</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit">02 3D Game Kit</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/problems">Problems with the Mecanim Character</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/respawn">Respawn</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/idle">Idle</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion">Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/movement">Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/turning">Turning</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/airborne">Airborne</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/landing">Landing</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/attack">Attack</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/flinch">Flinch</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/die">Die</a></li>

                    </ul>
                </li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual">User Manual</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/playing">Playing Animations</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/playing/states">States</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/inspector">Inspector</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/component-types">Component Types</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/directional-sets">Directional Animation Sets</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/transitions">Transitions</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/transitions/types">Transition Types</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/blending">Blending</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/blending/fading">Fading</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/layers">Layers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/mixers">Mixers</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/events">Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/events/animation">Animation Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/animancer">Animancer Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/end">End Events</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/manual/fsm">Finite State Machines</a></li>
                <li><a href="/animancer/v4-0/docs/manual/animator-controllers">Animator Controllers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/ik">Inverse Kinematics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/bugs">Unity Bugs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/bugs/inconsistent-timing">Inconsistent Timing</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/paused-skinned-mesh-update">Paused Skinned Mesh Update</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/resetting-animated-values">Resetting Animated Values</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/unused-graph-destroy-warning">Unused Graph Destroy Warning</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/update-modes">Update Modes</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/source">Source Code</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/source/dlls">DLLs</a></li>
                <li><a href="/animancer/v4-0/docs/source/creating-custom-states">Creating Custom States</a></li>
                <li><a href="/animancer/v4-0/docs/source/graph-structure">Graph Structure</a></li>
                <li><a href="/animancer/v4-0/docs/source/asset-sources">Asset Sources</a></li>
                <li><a href="/animancer/v4-0/docs/source/coding-standard">Coding Standard</a></li>
                <li><a href="/animancer/v4-0/docs/source/default-script-template">Default Script Template</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/changes">Change Log</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0-beta">Beta Test v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0">Progress of v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-1">Animancer v3.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-0">Animancer v3.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v2-0">Animancer v2.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-3">Animancer v1.3</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-2">Animancer v1.2</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-1">Animancer v1.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-0">Animancer v1.0</a></li>

                    </ul>
                </li>

                    </ul>
                            
                </section>                
            </aside>
            
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                



		<section class="content-header">
			<h1>02 Root Motion</h1>
		</section>
	<section class="content">
		<blockquote class="blockquote">
<p><strong>Difficulty</strong>: <a href="../../../introduction/glossary#example-difficulty">Beginner</a></p>
<p><strong>Location</strong>: <em>Assets/Plugins/Animancer/Examples/03 Locomotion/02 Root Motion</em></p>
<p><strong>Namespace</strong>: <a href="../../../../api/Animancer.Examples.Locomotion"><code>Animancer.Examples.Locomotion</code></a></p>
</blockquote>
<p>This example demonstrates how you can use a custom <a href="../../../manual/transitions">Transition class</a> to determine whether each animation should use <a href="https://docs.unity3d.com/Manual/RootMotion.html">Root Motion</a> or not and redirect the Root Motion to a different object if you want to.</p>
<p><img src="root-motion.gif" class="img-responsive"></p>
<p></p><details><summary>The <code><a href="/animancer/v4-0/api/Animancer.Examples.Locomotion/RootMotion">RootMotion</a></code> script looks like this (with the comments removed since we are about to explain how it works):</summary><p>
</p><pre><code class="language-cs">using Animancer;
using System;
using UnityEngine;

public sealed class <a href="/animancer/v4-0/api/Animancer.Examples.Locomotion/RootMotion">RootMotion</a> : MonoBehaviour
{
    [Serializable]
    public class MotionTransition : <a href="/animancer/v4-0/api/Animancer/Transition">ClipState.Transition</a>
    {
        [SerializeField, Tooltip("Determines if Root Motion should be enabled when this animation plays")]
        private bool _ApplyRootMotion;

        public override void Apply(AnimancerState state)
        {
            base.Apply(state);
            state.Root.Component.Animator.applyRootMotion = _ApplyRootMotion;
        }
    }

    [SerializeField] private <a href="/animancer/v4-0/api/Animancer/AnimancerComponent">AnimancerComponent</a> _Animancer;
    [SerializeField] private float _MaxDistance;
    [SerializeField] private MotionTransition[] _Animations;

    private Vector3 _Start;

    private void OnEnable()
    {
        _Start = transform.position;
        Play(0);
    }

    public void Play(int index)
    {
        _Animancer.Play(_Animations[index]);
    }

    private void FixedUpdate()
    {
        if (Vector3.Distance(_Start, transform.position) &gt; _MaxDistance)
            transform.position = _Start;
    }

    [SerializeField] private Transform _MotionTransform;
    [SerializeField] private Rigidbody _MotionRigidbody;
    [SerializeField] private CharacterController _MotionCharacterController;

    private void OnAnimatorMove()
    {
        if (!_Animancer.Animator.applyRootMotion)
            return;

        if (_MotionTransform != null)
        {
            _MotionTransform.position += _Animancer.Animator.deltaPosition;
            _MotionTransform.rotation *= _Animancer.Animator.deltaRotation;
        }
        else if (_MotionRigidbody != null)
        {
            _MotionRigidbody.MovePosition(_MotionRigidbody.position + _Animancer.Animator.deltaPosition);
            _MotionRigidbody.MoveRotation(_MotionRigidbody.rotation * _Animancer.Animator.deltaRotation);
        }
        else if (_MotionCharacterController != null)
        {
            _MotionCharacterController.Move(_Animancer.Animator.deltaPosition);
            _MotionCharacterController.transform.rotation *= _Animancer.Animator.deltaRotation;
        }
        else
        {
            _Animancer.Animator.ApplyBuiltinRootMotion();
        }
    }
}
</code></pre>
<p></p></details><p></p>
<h1 id="teleporting">Teleporting</h1>
<p>Since the character will be moving, we want to make them teleport back to the start whenever they move too far away.</p>
<p>First we need to store the start position. We could use a <a href="../../../introduction/cs/variables#serialized-fields">Serialized Field</a> to specify the position in the Inspector, but instead it will be more convenient if we just use whatever position the character is at when the scene starts. So we need a serialized field to specify how far away they can get, a non-serialized field to store the position, and an <code>OnEnable</code> method to set that value on startup:</p>
<pre><code class="language-cs">[SerializeField] private float _MaxDistance;

private Vector3 _Start;

private void OnEnable()
{
    // "transform" is the Transform component of the GameObject this script is attached to.
    _Start = transform.position;
}
</code></pre>
<p>Then we can use <a href="https://docs.unity3d.com/ScriptReference/Vector3.Distance"><code>Vector3.Distance</code></a> each frame to check how far the character has gotten from the start and set their position back there if necessary:</p>
<pre><code class="language-cs">private void FixedUpdate()
{
    if (Vector3.Distance(_Start, transform.position) &gt; _MaxDistance)
        transform.position = _Start;
}
</code></pre>
<p>Since movement relates to physics which should be independant of the rendering frame rate, the character's animation Update Mode set to <code>Animate Physics</code>:</p>
<p><img src="update-mode.png" class="img-responsive"></p>
<p>And since that means it will only be moved by physics updates, we want to do this distance check in <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.FixedUpdate"><code>FixedUpdate</code></a> rather than <a href="https://docs.unity3d.com/ScriptReference/MonoBehaviour.Update"><code>Update</code></a>.</p>
<h1 id="animation-metadata">Animation Metadata</h1>
<p>It is often necessary to associate some additional data with an <code>AnimationClip</code> reference. In this case, we just want a <code>bool</code> to indicate whether the <code>Animator.applyRootMotion</code> should be enabled when playing that animation or not.</p>
<p>This could be done by simply having an extra field next to each reference like so:</p>
<pre><code class="language-cs">[SerializeField] private AnimationClip _Idle;
[SerializeField] private bool _IdleRootMotion;
[SerializeField] private AnimationClip _Walk;
[SerializeField] private bool _WalkRootMotion;
</code></pre>
<p>Or with arrays:</p>
<pre><code class="language-cs">[SerializeField] private AnimationClip[] _Animations;
[SerializeField] private bool[] _AnimationsApplyRootMotion;
</code></pre>
<p>But those approaches are messy and require extra effort every time they are used.</p>
<p>Instead, we can make a class with a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.serializableattribute"><code>System.Serializable</code></a> attribute so that it can be used as a <a href="../../../introduction/cs/variables#serialized-fields">Serialized Field</a> to hold both fields next to each other:</p>
<pre><code class="language-cs">[Serializable]
public class MotionClip
{
    public AnimationClip clip;
    public bool applyRootMotion;
}
</code></pre>
<p>That way we could make as many fields as we want using that type then use a simple method to play them and apply the metadata:</p>
<pre><code class="language-cs">[SerializeField] private MotionClip _Idle;
[SerializeField] private MotionClip _Walk;

public void Play(MotionClip motion)
{
    _Animancer.Play(motion.clip);
    _Animancer.Animator.applyRootMotion = motion.applyRootMotion;
}
</code></pre>
<p>Now we can just call <code>Play(_Idle)</code> or <code>Play(_Walk)</code> and we could use a <code>MotionClip</code> in any script without manually adding a <code>bool</code> alongside every <code>AnimationClip</code>.</p>
<p>Since we want to control this particular example with <a href="../../basics/scene-setup#buttons">UI Buttons</a>, we instead use an array of <code>MotionClip</code>s so we can add an <a href="../../../introduction/cs/methods#overloads">Overload</a> of the <code>Play</code> method which just takes an <code>int</code> parameter:</p>
<pre><code class="language-cs">[SerializeField] private MotionClip[] _Animations;

public void Play(int index)
{
    Play(_Animations[index]);// Call the Play method above.
}
</code></pre>
<p>That gives us a simple grouping in the Inspector (and in code) where the metadata is managed alongside the <code>AnimationClip</code> reference:</p>
<p><img src="serializables.png" class="img-responsive"></p>
<h1 id="transitions">Transitions</h1>
<p>There are plenty of other kinds of metadata that you could add with this approach such as transition duration, start time, speed, a toggle for <a href="../../../ik">Inverse Kinematics</a>, or information more specific to your particular game like a "poise" value to indicate how easily each animation can be interrupted by enemy attacks. Fortunately, Animancer already has some inbuilt <a href="../../../manual/transitions">Transitions</a> which we can <a href="../../../introduction/cs/inheritance">Inherit</a> from so you do not have to do it all yourself:</p>
<pre><code class="language-cs">// Replace the old MotionClip class with this.
[Serializable]
public class MotionTransition : <a href="/animancer/v4-0/api/Animancer/Transition">ClipState.Transition</a>
{
    [SerializeField, Tooltip("Determines if Root Motion should be enabled when this animation plays")]
    private bool _ApplyRootMotion;
</code></pre>
<p><code><a href="/animancer/v4-0/api/Animancer/Transition">ClipState.Transition</a></code> already has the <code>AnimationClip</code>, transition duration, start time, and speed, so all we need to add is the Root Motion <code>bool</code>. Then <a href="../../../introduction/cs/inheritance"><code>override</code></a> its <code>Apply</code> method to set the <code>Animator.applyRootMotion</code> property accordingly:</p>
<pre><code class="language-cs">    public override void Apply(AnimancerState state)
    {
        base.Apply(state);
        state.Root.Component.Animator.applyRootMotion = _ApplyRootMotion;
    }
}

// And change the type of the _Animations field.
[SerializeField] private MotionTransition[] _Animations;
</code></pre>
<p>This way we get all those extra details in the Inspector without much extra effort (obviously we already got it working the other way, but doing it this way from the start would be just as easy).</p>
<p><img src="transitions.png" class="img-responsive"></p>
<h1 id="redirecting-root-motion">Redirecting Root Motion</h1>
<p>It is often useful to have your character's model as a separate object from their other aspects (such as a <code>Rigidbody</code> and their other scripts), in which case you will need to redirect the Root Motion to another object. This is very easy to do, though it is slightly different depending on what system you normally use to move the character.</p>
<p>First we need a reference to the object we want to apply the Root Motion to. This example shows each of the common movement systems, but in a real game you would only use one of the following:</p>
<pre><code class="language-cs">[SerializeField] private Transform _MotionTransform;
[SerializeField] private Rigidbody _MotionRigidbody;
[SerializeField] private CharacterController _MotionCharacterController;
</code></pre>
<p><img src="redirect-inspector.png" class="img-responsive"></p>
<p>Then you can just implement a method called <code>OnAnimatorMove</code> which Unity will call when it would normally apply Root Motion:</p>
<pre><code class="language-cs">private void OnAnimatorMove()
{
    if (!_Animancer.Animator.applyRootMotion)
        return;

    if (_MotionTransform != null)
    {
        _MotionTransform.position += _Animancer.Animator.deltaPosition;
        _MotionTransform.rotation *= _Animancer.Animator.deltaRotation;
    }
    else if (_MotionRigidbody != null)
    {
        _MotionRigidbody.MovePosition(_MotionRigidbody.position + _Animancer.Animator.deltaPosition);
        _MotionRigidbody.MoveRotation(_MotionRigidbody.rotation * _Animancer.Animator.deltaRotation);
    }
    else if (_MotionCharacterController != null)
    {
        _MotionCharacterController.Move(_Animancer.Animator.deltaPosition);
        _MotionCharacterController.transform.rotation *= _Animancer.Animator.deltaRotation;
    }
    else
    {
        // If we aren't retargeting, just let Unity apply the Root Motion normally.
        _Animancer.Animator.ApplyBuiltinRootMotion();
    }
}
</code></pre>
<p>To demonstrate the concept, we can create a cube and assign it to the <code>_MotionTransform</code> field (though you would normally redirect Root Motion to a parent of the model so that they both move together):</p>
<p><img src="redirect-cube.gif" class="img-responsive"></p>

	</section>
                
            </div>           
            
            <!-- Footer -->
            <footer class="main-footer">
            </footer>
            
        </div>
        <div class="wrapper bottom-wrapper">
            <footer class="bottom-footer">
                Generated by <a href="https://wyam.io">Wyam</a>
            </footer>
        </div>
        <a href="javascript:" id="return-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <script>           
            // Close the sidebar if we select an anchor link
            $(".main-sidebar a[href^='#']:not('.expand')").click(function(){
                $(document.body).removeClass('sidebar-open');
            });
            
            $(document).ready(function() {
                mermaid.initialize(
                {
                    flowchart:
                    {
                        useMaxWidth: false
                    },
					startOnLoad: false,
					cloneCssStyles: false
                });     
                mermaid.init(undefined, ".mermaid");

                // Remove the max-width setting that Mermaid sets
                var mermaidSvg = $('.mermaid svg');
                mermaidSvg.addClass('img-responsive');
                mermaidSvg.css('max-width', '');

                // Make it scrollable
				var target = document.querySelector(".mermaid svg");
				if(target !== null)
				{
					var panZoom = window.panZoom = svgPanZoom(target, {
						zoomEnabled: true,
						controlIconsEnabled: true,
						fit: true,
						center: true,
                        maxZoom: 20,
                        zoomScaleSensitivity: 0.6
					});			                          

                    // Do the reset once right away to fit the diagram
                    panZoom.resize();
                    panZoom.fit();
                    panZoom.center();
                    
                    $(window).resize(function(){
                        panZoom.resize();
                        panZoom.fit();
                        panZoom.center();
                    });
				}
                
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });  
            });

            hljs.initHighlightingOnLoad();

            // Back to top
            $(window).scroll(function() {
                if ($(this).scrollTop() >= 200) {        // If page is scrolled more than 50px
                    $('#return-to-top').fadeIn(1000);    // Fade in the arrow
                } else {
                    $('#return-to-top').fadeOut(1000);   // Else fade out the arrow
                }
            });
            $('#return-to-top').click(function() {      // When arrow is clicked
                $('body,html').animate({
                    scrollTop : 0                       // Scroll to top of body
                }, 500);
            });
        </script>
    
</body></html>